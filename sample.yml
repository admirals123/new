using StackExchange.Redis;
using Azure.Identity;

namespace RedisCacheDemo
{
    class Program
    {
        static async Task Main(string[] args)
        {
            // ***** Important: Replace Placeholders *****
            var redisCacheName = "<YOUR_REDIS_CACHE_NAME>";

            // Get hostname and port from connection string template 
            var template = $"{redisCacheName}.redis.cache.windows.net:6380,password=,ssl=True,abortConnect=False";
            string[] parts = template.Split(',');
            string hostname = parts[0].Split(':')[0];
            int port = Convert.ToInt32(parts[0].Split(':')[1]);

            // Configure client options
            ConfigurationOptions options = new ConfigurationOptions
            {
                EndPoints = { { hostname, port } },
                Ssl = true,   
                AbortOnConnectFail = false 
            };

            // Connect (without immediate customization)
            ConnectionMultiplexer redis = ConnectionMultiplexer.Connect(options); 

            // Customize the AUTH command
            redis.CommandMap.Set("AUTH", (string password)  => redis.GetDatabase().Execute("AUTH", password)); 

            // Obtain token and authenticate
            var credential = new DefaultAzureCredential();
            string token = credential.GetToken(new Azure.Core.TokenRequestContext(new[] { "https://management.azure.com/" })).Token;
            redis.GetDatabase().Execute("AUTH", token); // Perform the actual authentication

            // ***** Redis Operations *****
            // Example: Set a key-value pair
            await redis.GetDatabase().StringSetAsync("message:hello", "world");

            // Example: Get the value
            string value = await redis.GetDatabase().StringGetAsync("message:hello");
            Console.WriteLine(value); 
        }
    }
}
