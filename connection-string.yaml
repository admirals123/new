using System;
using Azure.Messaging.ServiceBus;

public class SendMessageToQueueWithManagedIdentity
{
    // Replace with your Service Bus namespace endpoint and queue name
    private static readonly string fullyQualifiedNamespace = "<your-service-bus-namespace>.servicebus.windows.net";
    private static readonly string queueName = "<your-queue-name>";

    public static async Task Main(string[] args)
    {
        // Use DefaultAzureCredential to acquire token from managed identity
        var credential = new DefaultAzureCredential();

        // Create a Service Bus client using the credential and namespace endpoint
        var serviceBusClient = new ServiceBusClient(fullyQualifiedNamespace, credential);

        // Create a sender for the specific queue
        var sender = serviceBusClient.CreateSender(queueName);

        // Create a message with some content
        var messageBody = "This is a message from a .NET application using managed identity.";
        var serviceBusMessage = new ServiceBusMessage(messageBody);

        try
        {
            // Send the message
            await sender.SendMessageAsync(serviceBusMessage);
            Console.WriteLine($"Message sent to queue: {queueName}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
        finally
        {
            // Close the sender and client connection
            await sender.DisposeAsync();
            await serviceBusClient.DisposeAsync();
        }
    }
}
