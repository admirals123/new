using Microsoft.Azure.ServiceBus;
using Microsoft.Azure.Services.AppAuthentication;
using System;
using System.Threading.Tasks;

class Program
{
    static async Task Main(string[] args)
    {
        try
        {
            // Create a token provider using AzureServiceTokenProvider for Managed Identity authentication
            var azureServiceTokenProvider = new AzureServiceTokenProvider();
            var tokenProvider = TokenProvider.CreateAzureActiveDirectoryTokenProvider(async (audience, authority, state) =>
            {
                return await azureServiceTokenProvider.GetAccessTokenAsync("https://servicebus.azure.net");
            });

            // Create a ServiceBusClient instance using the token provider
            var serviceBusClient = new ServiceBusClient("your-service-bus-namespace.servicebus.windows.net", tokenProvider);

            // Create a ServiceBusSender instance
            var sender = serviceBusClient.CreateSender("your-queue-name");

            // Create a message and send it to the queue
            var message = new Message(System.Text.Encoding.UTF8.GetBytes("Hello, Azure Service Bus!"));
            await sender.SendAsync(message);

            Console.WriteLine("Message sent successfully.");

            // Close the ServiceBusClient
            await serviceBusClient.DisposeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
        }
    }
}
